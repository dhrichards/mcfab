#%%
import numpy as np
import shtns


class Reconstruct:
    ''' Class to reconstruct an odf of resolution L=6 from discrete points'''
    def __init__(self,n,m):

        self.a6 = make_a6(n,m)

        self.sh = shtns.sht(6,6)
        self.f = self.sh.spec_array()

        self.f = self.reverse_tensor6(self.a6,self.f)


    def plot(self,hemisphere=False):
        nlats, nlons = self.sh.set_grid(100,100,\
                shtns.SHT_PHI_CONTIGUOUS,1.e-10)
    
        theta_vals = np.arccos(self.sh.cos_theta)
        phi_vals = (2.0*np.pi/nlons)*np.arange(nlons)

        ra,dec = decra_from_polar(phi_vals,theta_vals)


        X, Y = np.meshgrid(ra, dec)

        fgrid = self.sh.synth(self.f)


        if hemisphere:
            

            fgrid = fgrid[0:nlats//2,:]
            X = X[0:nlats//2,:]
            Y = Y[0:nlats//2,:]

        return X,Y,fgrid
    
    
    def reverse_tensor6(self,a,psi):


        psi[self.sh.idx(0,0)] = a[0,0,0,0,0,0]\
                        +3.*a[0,0,0,0,1,1]\
                        +3.*a[0,0,0,0,2,2]\
                        +3.*a[0,0,1,1,1,1]\
                        +6.*a[0,0,1,1,2,2]\
                        +3.*a[0,0,2,2,2,2]\
                        +a[1,1,1,1,1,1]\
                        +3.*a[1,1,1,1,2,2]\
                        +3.*a[1,1,2,2,2,2]\
                        +a[2,2,2,2,2,2]

        psi[self.sh.idx(2,0)] = -1.118033988749895*a[0,0,0,0,0,0]\
                        -3.3541019662496847*a[0,0,0,0,1,1]\
                        -3.3541019662496847*a[0,0,1,1,1,1]\
                        +3.3541019662496847*a[0,0,2,2,2,2]\
                        -1.118033988749895*a[1,1,1,1,1,1]\
                        +3.3541019662496847*a[1,1,2,2,2,2]\
                        +2.23606797749979*a[2,2,2,2,2,2]

        psi[self.sh.idx(2,1)] = -2.7386127875258306*a[0,0,0,0,0,2]\
                        -5.477225575051661*a[0,0,0,1,1,2]\
                        -5.477225575051661*a[0,0,0,2,2,2]\
                        -2.7386127875258306*a[0,1,1,1,1,2]\
                        -5.477225575051661*a[0,1,1,2,2,2]\
                        -2.7386127875258306*a[0,2,2,2,2,2]

        psi[self.sh.idx(2,1)] += 1j*(2.7386127875258306*a[0,0,0,0,1,2]\
                        +5.477225575051661*a[0,0,1,1,1,2]\
                        +5.477225575051661*a[0,0,1,2,2,2]\
                        +2.7386127875258306*a[1,1,1,1,1,2]\
                        +5.477225575051661*a[1,1,1,2,2,2]\
                        +2.7386127875258306*a[1,2,2,2,2,2])

        psi[self.sh.idx(2,2)] = 1.3693063937629153*a[0,0,0,0,0,0]\
                        +1.3693063937629153*a[0,0,0,0,1,1]\
                        +2.7386127875258306*a[0,0,0,0,2,2]\
                        -1.3693063937629153*a[0,0,1,1,1,1]\
                        +1.3693063937629153*a[0,0,2,2,2,2]\
                        -1.3693063937629153*a[1,1,1,1,1,1]\
                        -2.7386127875258306*a[1,1,1,1,2,2]\
                        -1.3693063937629153*a[1,1,2,2,2,2]

        psi[self.sh.idx(2,2)] += 1j*(-2.7386127875258306*a[0,0,0,0,0,1]\
                        -5.477225575051661*a[0,0,0,1,1,1]\
                        -5.477225575051661*a[0,0,0,1,2,2]\
                        -2.7386127875258306*a[0,1,1,1,1,1]\
                        -5.477225575051661*a[0,1,1,1,2,2]\
                        -2.7386127875258306*a[0,1,2,2,2,2])

        psi[self.sh.idx(4,0)] = 1.125*a[0,0,0,0,0,0]\
                        +3.375*a[0,0,0,0,1,1]\
                        -7.875*a[0,0,0,0,2,2]\
                        +3.375*a[0,0,1,1,1,1]\
                        -15.75*a[0,0,1,1,2,2]\
                        -6.*a[0,0,2,2,2,2]\
                        +1.125*a[1,1,1,1,1,1]\
                        -7.875*a[1,1,1,1,2,2]\
                        -6.*a[1,1,2,2,2,2]\
                        +3.*a[2,2,2,2,2,2]

        psi[self.sh.idx(4,1)] = 5.031152949374527*a[0,0,0,0,0,2]\
                        +10.062305898749054*a[0,0,0,1,1,2]\
                        -1.6770509831248424*a[0,0,0,2,2,2]\
                        +5.031152949374527*a[0,1,1,1,1,2]\
                        -1.6770509831248424*a[0,1,1,2,2,2]\
                        -6.708203932499369*a[0,2,2,2,2,2]

        psi[self.sh.idx(4,1)] += 1j*(-5.031152949374527*a[0,0,0,0,1,2]\
                        -10.062305898749054*a[0,0,1,1,1,2]\
                        +1.6770509831248424*a[0,0,1,2,2,2]\
                        -5.031152949374527*a[1,1,1,1,1,2]\
                        +1.6770509831248424*a[1,1,1,2,2,2]\
                        +6.708203932499369*a[1,2,2,2,2,2])

        psi[self.sh.idx(4,2)] = -1.1858541225631423*a[0,0,0,0,0,0]\
                        -1.1858541225631423*a[0,0,0,0,1,1]\
                        +5.929270612815712*a[0,0,0,0,2,2]\
                        +1.1858541225631423*a[0,0,1,1,1,1]\
                        +7.115124735378854*a[0,0,2,2,2,2]\
                        +1.1858541225631423*a[1,1,1,1,1,1]\
                        -5.929270612815712*a[1,1,1,1,2,2]\
                        -7.115124735378854*a[1,1,2,2,2,2]

        psi[self.sh.idx(4,2)] += 1j*(2.3717082451262845*a[0,0,0,0,0,1]\
                        +4.743416490252569*a[0,0,0,1,1,1]\
                        -11.858541225631424*a[0,0,0,1,2,2]\
                        +2.3717082451262845*a[0,1,1,1,1,1]\
                        -11.858541225631424*a[0,1,1,1,2,2]\
                        -14.230249470757707*a[0,1,2,2,2,2])

        psi[self.sh.idx(4,3)] = -4.437059837324712*a[0,0,0,0,0,2]\
                        +8.874119674649425*a[0,0,0,1,1,2]\
                        -4.437059837324712*a[0,0,0,2,2,2]\
                        +13.311179511974137*a[0,1,1,1,1,2]\
                        +13.311179511974137*a[0,1,1,2,2,2]

        psi[self.sh.idx(4,3)] += 1j*(13.311179511974137*a[0,0,0,0,1,2]\
                        +8.874119674649425*a[0,0,1,1,1,2]\
                        +13.311179511974137*a[0,0,1,2,2,2]\
                        -4.437059837324712*a[1,1,1,1,1,2]\
                        -4.437059837324712*a[1,1,1,2,2,2])

        psi[self.sh.idx(4,4)] = 1.5687375497513916*a[0,0,0,0,0,0]\
                        -7.843687748756959*a[0,0,0,0,1,1]\
                        +1.5687375497513916*a[0,0,0,0,2,2]\
                        -7.843687748756959*a[0,0,1,1,1,1]\
                        -9.41242529850835*a[0,0,1,1,2,2]\
                        +1.5687375497513916*a[1,1,1,1,1,1]\
                        +1.5687375497513916*a[1,1,1,1,2,2]

        psi[self.sh.idx(4,4)] += 1j*(-6.274950199005566*a[0,0,0,0,0,1]\
                        -6.274950199005566*a[0,0,0,1,2,2]\
                        +6.274950199005566*a[0,1,1,1,1,1]\
                        +6.274950199005566*a[0,1,1,1,2,2])

        psi[self.sh.idx(6,0)] = -1.1267347735824966*a[0,0,0,0,0,0]\
                        -3.38020432074749*a[0,0,0,0,1,1]\
                        +20.28122592448494*a[0,0,0,0,2,2]\
                        -3.38020432074749*a[0,0,1,1,1,1]\
                        +40.56245184896988*a[0,0,1,1,2,2]\
                        -27.04163456597992*a[0,0,2,2,2,2]\
                        -1.1267347735824966*a[1,1,1,1,1,1]\
                        +20.28122592448494*a[1,1,1,1,2,2]\
                        -27.04163456597992*a[1,1,2,2,2,2]\
                        +3.605551275463989*a[2,2,2,2,2,2]

        psi[self.sh.idx(6,1)] = -7.302075903467452*a[0,0,0,0,0,2]\
                        -14.604151806934905*a[0,0,0,1,1,2]\
                        +29.20830361386981*a[0,0,0,2,2,2]\
                        -7.302075903467452*a[0,1,1,1,1,2]\
                        +29.20830361386981*a[0,1,1,2,2,2]\
                        -11.683321445547923*a[0,2,2,2,2,2]

        psi[self.sh.idx(6,1)] += 1j*(7.302075903467452*a[0,0,0,0,1,2]\
                        +14.604151806934905*a[0,0,1,1,1,2]\
                        -29.20830361386981*a[0,0,1,2,2,2]\
                        +7.302075903467452*a[1,1,1,1,1,2]\
                        -29.20830361386981*a[1,1,1,2,2,2]\
                        +11.683321445547923*a[1,2,2,2,2,2])

        psi[self.sh.idx(6,2)] = 1.154559575119448*a[0,0,0,0,0,0]\
                        +1.154559575119448*a[0,0,0,0,1,1]\
                        -18.472953201911167*a[0,0,0,0,2,2]\
                        -1.154559575119448*a[0,0,1,1,1,1]\
                        +18.472953201911167*a[0,0,2,2,2,2]\
                        -1.154559575119448*a[1,1,1,1,1,1]\
                        +18.472953201911167*a[1,1,1,1,2,2]\
                        -18.472953201911167*a[1,1,2,2,2,2]

        psi[self.sh.idx(6,2)] += 1j*(-2.309119150238896*a[0,0,0,0,0,1]\
                        -4.618238300477792*a[0,0,0,1,1,1]\
                        +36.945906403822335*a[0,0,0,1,2,2]\
                        -2.309119150238896*a[0,1,1,1,1,1]\
                        +36.945906403822335*a[0,1,1,1,2,2]\
                        -36.945906403822335*a[0,1,2,2,2,2])

        psi[self.sh.idx(6,3)] = 6.927357450716688*a[0,0,0,0,0,2]\
                        -13.854714901433375*a[0,0,0,1,1,2]\
                        -18.472953201911167*a[0,0,0,2,2,2]\
                        -20.782072352150063*a[0,1,1,1,1,2]\
                        +55.4188596057335*a[0,1,1,2,2,2]

        psi[self.sh.idx(6,3)] += 1j*(-20.782072352150063*a[0,0,0,0,1,2]\
                        -13.854714901433375*a[0,0,1,1,1,2]\
                        +55.4188596057335*a[0,0,1,2,2,2]\
                        +6.927357450716688*a[1,1,1,1,1,2]\
                        -18.472953201911167*a[1,1,1,2,2,2])

        psi[self.sh.idx(6,4)] = -1.2647566465530038*a[0,0,0,0,0,0]\
                        +6.323783232765019*a[0,0,0,0,1,1]\
                        +12.647566465530039*a[0,0,0,0,2,2]\
                        +6.323783232765019*a[0,0,1,1,1,1]\
                        -75.88539879318023*a[0,0,1,1,2,2]\
                        -1.2647566465530038*a[1,1,1,1,1,1]\
                        +12.647566465530039*a[1,1,1,1,2,2]

        psi[self.sh.idx(6,4)] += 1j*(5.059026586212015*a[0,0,0,0,0,1]\
                        -50.590265862120155*a[0,0,0,1,2,2]\
                        -5.059026586212015*a[0,1,1,1,1,1]\
                        +50.590265862120155*a[0,1,1,1,2,2])

        psi[self.sh.idx(6,5)] = -5.932234507333641*a[0,0,0,0,0,2]\
                        +59.32234507333641*a[0,0,0,1,1,2]\
                        -29.661172536668204*a[0,1,1,1,1,2]

        psi[self.sh.idx(6,5)] += 1j*(29.661172536668204*a[0,0,0,0,1,2]\
                        -59.32234507333641*a[0,0,1,1,1,2]\
                        +5.932234507333641*a[1,1,1,1,1,2])

        psi[self.sh.idx(6,6)] = 1.7124885948525321*a[0,0,0,0,0,0]\
                        -25.687328922787984*a[0,0,0,0,1,1]\
                        +25.687328922787984*a[0,0,1,1,1,1]\
                        -1.7124885948525321*a[1,1,1,1,1,1]

        psi[self.sh.idx(6,6)] += 1j*(-10.274931569115193*a[0,0,0,0,0,1]\
                        +34.24977189705064*a[0,0,0,1,1,1]\
                        -10.274931569115193*a[0,1,1,1,1,1])
        return psi







def make_a6(n,m):
    a6 = np.zeros((3,3,3,3,3,3))
    n6 = np.einsum('ip,jp,kp,lp,mp,np->ijklmnp',n,n,n,n,n,n)
    for i in range(3):
        for j in range(3):
            for k in range(3):
                for l in range(3):
                    for p in range(3):
                        for q in range(3):
                            a6[i,j,k,l,p,q] = np.mean(m*n6[i,j,k,l,p,q,:])
    return a6


def decra_from_polar(phi, theta):
    """ Convert from ra and dec to spherical polar coordinates.
    Parameters
    ----------
    phi, theta : float or numpy.array
        azimuthal and polar angle in radians
    Returns
    -------
    ra, dec : float or numpy.array
        Right ascension and declination in degrees.
    """
    ra = phi * (phi < np.pi) + (phi-2*np.pi)*(phi > np.pi)
    dec = np.pi/2-theta
    return ra/np.pi*180, dec/np.pi*180

    
